# トラブルシューティング

> **関連ドキュメント**  
> [README.md](README.md) | [DEVELOPMENT.md](DEVELOPMENT.md) | [FAQ.md](FAQ.md)

このドキュメントは、SporTagLyticsの使用中によくある問題と解決方法を詳しく説明します。

---

## 目次

1. [映像再生の問題](#映像再生の問題)
2. [音声同期の問題](#音声同期の問題)
3. [タイムライン関連の問題](#タイムライン関連の問題)
4. [パッケージ管理の問題](#パッケージ管理の問題)
5. [ホットキーの問題](#ホットキーの問題)
6. [設定の問題](#設定の問題)
7. [パフォーマンスの問題](#パフォーマンスの問題)
8. [エクスポート/インポートの問題](#エクスポートインポートの問題)
9. [ログファイルとデバッグモード](#ログファイルとデバッグモード)

---

## 映像再生の問題

### 映像が再生されない

**症状**: 映像ファイルを選択したが、黒い画面のまま再生されない。

**原因と対処法**:

1. **対応していないコーデック**
   - **確認方法**: 別のプレイヤー（VLC、QuickTime等）で再生できるか確認
   - **対処法**: MP4またはMOV形式、H.264/AVC（映像）+ AAC（音声）に変換
   - **変換例**（FFmpeg使用）:
     ```bash
     ffmpeg -i input.mp4 -c:v libx264 -c:a aac output.mp4
     ```

2. **ファイルパスの問題**
   - **確認方法**: ファイルが移動または削除されていないか確認
   - **対処法**: パッケージ作成時にファイルコピーを選択（推奨）

3. **ファイル権限の問題**
   - **確認方法**: Finderでファイルを右クリック→「情報を見る」→権限を確認
   - **対処法**: 読み取り権限を付与
     ```bash
     chmod 644 /path/to/video.mp4
     ```

4. **破損したファイル**
   - **確認方法**: 別のプレイヤーで再生できるか確認
   - **対処法**: 元のファイルを再エンコード

### 映像がカクカクする / フリーズする

**原因と対処法**:

1. **高解像度・高ビットレート**
   - **確認方法**: `ffprobe -i video.mp4` でビットレートを確認
   - **対処法**: 解像度を下げる（1080p推奨）、ビットレートを調整
     ```bash
     ffmpeg -i input.mp4 -vf scale=1920:1080 -b:v 5M output.mp4
     ```

2. **メモリ不足**
   - **確認方法**: アクティビティモニタでメモリ使用量を確認
   - **対処法**: 他のアプリケーションを終了

3. **ディスクI/O遅延**
   - **確認方法**: 外付けHDDではなくSSDを使用しているか確認
   - **対処法**: 映像ファイルをローカルSSDにコピー

### 2つの映像が同期しない

→ [音声同期の問題](#音声同期の問題)を参照

---

## 音声同期の問題

### 自動音声同期が失敗する

**症状**: 「音声同期を実行」しても、信頼度スコアが低い（<70%）、またはエラーが出る。

**原因と対処法**:

1. **音声トラックが存在しない**
   - **確認方法**: QuickTimeやVLCで音声が再生されるか確認
   - **対処法**: 音声がない場合は手動同期を使用

2. **音声が異なる（別のマイク）**
   - **確認方法**: 2つのカメラが異なる場所に設置され、異なる音源を録音している
   - **対処法**: 手動同期（`Cmd+Shift+M`）を使用

3. **無音区間が多い**
   - **確認方法**: 映像の最初の30秒に音声が少ない
   - **対処法**: 音声が多い区間から再生して手動同期

4. **ノイズが多い**
   - **確認方法**: 風切り音、会場ノイズが大きい
   - **対処法**: 音声をクリーンアップしてから再度同期

**デバッグ方法**:

音声同期の詳細ログを確認するには、[docs/audio-sync-offset-specification.md](docs/audio-sync-offset-specification.md#トラブルシューティング)を参照してください。

### 手動同期がうまくいかない

**症状**: 手動モードで調整しても、映像がずれる。

**対処法**:

1. **手動オフセット調整ダイアログを使用**
   - `Cmd+Shift+O`でオフセット値を直接入力
   - 例: セカンダリが2秒遅れている場合は `-2.0` を入力

2. **同期リセット後に再度手動同期**
   - `Cmd+Shift+R`で同期をリセット
   - `Cmd+Shift+M`で現在位置で手動同期

3. **手動モードで個別調整**
   - `Cmd+Shift+T`で手動モードをオン
   - 各プレイヤーのシークバーを個別に操作
   - 正確な位置で`Cmd+Shift+M`を実行

### 同期がセッション間で保持されない

**症状**: アプリを再起動すると同期がリセットされる。

**確認方法**: `.metadata/config.json`に`syncData`が保存されているか確認

**対処法**:

1. パッケージディレクトリへの書き込み権限を確認
2. 同期実行後、ファイルを保存（`Cmd+S`）

---

## タイムライン関連の問題

### タイムラインが保存されない

**症状**: イベントを追加したが、再起動後に消えている。

**原因と対処法**:

1. **書き込み権限がない**
   - **確認方法**: `timeline.json`の権限を確認
   - **対処法**: 書き込み権限を付与
     ```bash
     chmod 644 /path/to/package/timeline.json
     ```

2. **ディスク容量不足**
   - **確認方法**: `df -h`でディスク使用量を確認
   - **対処法**: 不要なファイルを削除

3. **自動保存が失敗している**
   - **確認方法**: コンソールにエラーが表示されているか確認（開発者ツール）
   - **対処法**: 手動保存（`Cmd+S`）を試行

### Undo/Redoが効かない

**症状**: `Cmd+Z`を押しても変更が元に戻らない。

**原因と対処法**:

1. **履歴制限に達している**
   - Undo履歴は最大50件
   - それ以前の変更は元に戻せません

2. **外部編集後**
   - `timeline.json`を外部エディタで編集した場合、履歴がリセットされます

### タイムラインの編集ダイアログが開かない

**症状**: イベントをダブルクリックしても編集ダイアログが表示されない。

**対処法**:

1. イベントを選択してEnterキーを押す
2. 右クリックメニューから「編集」を選択

### ラベルが正しく保存されない

**症状**: ラベルを選択して記録したが、保存されていない。

**確認方法**: `timeline.json`を開き、該当イベントの`labels`配列を確認

**対処法**:

1. コードウィンドウがラベルモードになっているか確認（コード/ラベルモード切替ボタン）
2. ラベルを選択後、アクションボタンをクリック
3. 既存イベントにラベルを追加する場合は、編集ダイアログまたは一括ラベル付与機能を使用

---

## パッケージ管理の問題

### パッケージが開けない

**症状**: 「パッケージを開く」でフォルダを選択したが、エラーが出る。

**原因と対処法**:

1. **`.metadata/config.json`が存在しない**
   - **確認方法**: Finderでフォルダ内を確認（隠しファイルを表示）
   - **対処法**: 新規パッケージとして作成し直す

2. **`config.json`の形式が不正**
   - **確認方法**: JSONバリデーターで検証
   - **対処法**: バックアップから復元、または手動修正

3. **パスが相対パスでない**
   - **確認方法**: `config.json`内の`angles[].relativePath`を確認
   - **対処法**: パスを`videos/`相対に修正

### 映像ファイルが見つからない

**症状**: パッケージを開いたが、「ファイルが見つかりません」エラーが出る。

**原因と対処法**:

1. **映像ファイルが移動/削除された**
   - **確認方法**: `videos/`ディレクトリ内を確認
   - **対処法**: 元のファイルをコピーし直す

2. **相対パスが間違っている**
   - **確認方法**: `config.json`の`angles[].relativePath`と実際のファイル名を比較
   - **対処法**: パスを修正

---

## ホットキーの問題

### ホットキーが反応しない

**症状**: ショートカットキーを押しても何も起こらない。

**原因と対処法**:

1. **ホットキーが衝突している**
   - **確認方法**: 設定画面→ホットキー設定で衝突警告を確認
   - **対処法**: 別のキーに変更

2. **禁止キーを使用している**
   - `Cmd+Q`, `Cmd+W`等のシステムキーは使用不可
   - **対処法**: 別のキーに変更

3. **フォーカスが別の要素にある**
   - **確認方法**: テキスト入力フィールドにカーソルがあるか確認
   - **対処法**: ビデオプレイヤーエリアをクリックしてフォーカスを戻す

4. **グローバルホットキーが無効化されている**
   - **確認方法**: 設定画面でホットキーが有効になっているか確認
   - **対処法**: ホットキーを再設定

### コードウィンドウのホットキーが効かない

**症状**: コードウィンドウに設定したホットキーでアクションが記録されない。

**原因と対処法**:

1. **別のコードウィンドウがアクティブ**
   - **確認方法**: 設定画面→コードウィンドウ設定で、どのコードウィンドウがアクティブか確認
   - **対処法**: アクティブなコードウィンドウを切り替える

2. **ホットキーが未設定**
   - **確認方法**: ボタンのホットキー設定を確認
   - **対処法**: 設定画面でホットキーを設定

---

## 設定の問題

### 設定が保存されない

**症状**: 設定を変更したが、再起動後に元に戻る。

**原因と対処法**:

1. **設定ファイルへの書き込み権限がない**
   - **確認方法**: macOSの場合は `~/Library/Application Support/sportaglytics/settings.json`
   - **対処法**: ディレクトリ権限を確認

2. **ディスク容量不足**
   - **対処法**: 不要なファイルを削除

### 設定ファイルの場所

各OSでの設定ファイル保存場所:

- **macOS**: `~/Library/Application Support/sportaglytics/settings.json`
- **Windows**: `%APPDATA%\sportaglytics\settings.json`
- **Linux**: `~/.config/sportaglytics/settings.json`

### 設定をリセットしたい

**対処法**:

1. アプリを終了
2. 上記の設定ファイルを削除
3. アプリを再起動（デフォルト設定で起動）

---

## パフォーマンスの問題

### アプリが重い / 応答しない

**原因と対処法**:

1. **大容量映像ファイル**
   - 4K映像は1080pに変換
   - 長時間映像（2時間以上）は分割

2. **メモリリーク**
   - アプリを再起動

3. **多数のタイムラインイベント**
   - 10,000件以上のイベントがある場合、フィルタリングを使用

### 音声同期の分析が遅い

**症状**: 音声同期の実行に5分以上かかる。

**原因と対処法**:

1. **長時間映像**
   - 現在、最初の120秒のみ分析
   - それ以上時間がかかる場合は、映像ファイルを再エンコード

2. **CPU使用率が高い**
   - 他のアプリケーションを終了

---

## エクスポート/インポートの問題

### CSVエクスポートが文字化けする

**症状**: CSVファイルをExcelで開くと日本語が文字化けする。

**対処法**:

1. Excelでファイルを開く際、エンコーディングを「UTF-8」に指定
2. または、Google SheetsでCSVをインポート

### SCTimeline形式でインポートできない

**症状**: SCTimelineファイルをインポートしようとするとエラーが出る。

**原因と対処法**:

1. **フォーマットが不正**
   - [docs/sctimeline-implementation.md](docs/sctimeline-implementation.md)の形式を確認
   - `rows`または`instances`キーが必要

2. **JSONシンタックスエラー**
   - JSONバリデーターで検証

### クリップ書き出しが失敗する

**症状**: FFmpegエラーが表示される。

**原因と対処法**:

1. **FFmpegがインストールされていない**
   - **確認方法**: ターミナルで `ffmpeg -version`
   - **対処法**: Homebrewでインストール
     ```bash
     brew install ffmpeg
     ```

2. **出力先ディレクトリの権限**
   - 書き込み権限を確認

3. **ディスク容量不足**
   - 十分な空き容量を確保

---

## ログファイルとデバッグモード

### ログファイルの場所

Electronのログファイル:

- **macOS**: `~/Library/Logs/sportaglytics/`
- **Windows**: `%USERPROFILE%\AppData\Roaming\sportaglytics\logs\`
- **Linux**: `~/.config/sportaglytics/logs/`

### デバッグモードの有効化

開発者ツールを開く:

1. メニュー「表示」→「開発者ツール」
2. またはショートカット: `Cmd+Option+I` (macOS) / `Ctrl+Shift+I` (Windows/Linux)

コンソールタブでエラーメッセージを確認できます。

### 音声同期のデバッグログ

詳細な音声同期ログを有効化するには、[docs/audio-sync-offset-specification.md](docs/audio-sync-offset-specification.md#デバッグログの読み方)を参照してください。

---

## それでも解決しない場合

上記で解決しない場合は、以下の情報を添えて[GitHubのIssue](https://github.com/Kou-ISK/sportaglytics/issues)に報告してください:

1. **OS**: macOS 14.2等
2. **アプリバージョン**: 設定画面で確認
3. **エラーメッセージ**: スクリーンショットまたはコピー
4. **再現手順**: 問題が発生する具体的な操作
5. **ログファイル**: 上記の場所から取得（可能であれば）

[FAQ.md](FAQ.md)や[GitHub Discussions](https://github.com/Kou-ISK/sportaglytics/discussions)も参照してください。
