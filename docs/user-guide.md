# SporTagLytics ユーザーガイド

## 目次

1. [はじめに](#はじめに)
2. [クイックスタート](#クイックスタート)
3. [パッケージ管理](#パッケージ管理)
4. [映像再生](#映像再生)
5. [イベントタグ付け](#イベントタグ付け)
6. [タイムライン編集](#タイムライン編集)
7. [統計分析](#統計分析)
8. [プレイリスト機能](#プレイリスト機能)
9. [データのインポート・エクスポート](#データのインポート・エクスポート)
10. [設定](#設定)
11. [ショートカットキー](#ショートカットキー)

---

## はじめに

SporTagLytics は、スポーツ映像のタグ付けと分析を効率化するElectronアプリケーションです。

### 主な機能

- **デュアル映像同期**: 寄り/引き2映像の自動同期再生
- **音声同期**: 音響分析による自動オフセット調整
- **イベントタグ付け**: ワンクリックでイベント記録
- **ビジュアルタイムライン**: 波形表示で直感的なイベント編集
- **統計ダッシュボード**: ポゼッション、モメンタム、クロス集計
- **プレイリスト**: フリーズフレーム、描画、クリップ書き出し
- **カスタマイズ可能**: コーディングパネルの自由配置

---

## クイックスタート

### 1. パッケージ作成

1. メニュー → 「新規パッケージ」
2. パッケージ名とチーム名を入力
3. 保存先ディレクトリを選択
4. 映像ファイルを選択（寄り必須、引き任意）
5. 「作成」ボタンで完了

**パッケージ構造**:

```
PackageName/
├── .metadata/
│   ├── config.json
│   └── sync.json
├── timeline.json
└── videos/
    ├── PackageName 寄り.mp4
    └── PackageName 引き.mp4
```

### 2. 映像再生と基本操作

- **Space**: 再生/一時停止
- **← / →**: 5秒スキップ
- **シークバー**: クリックで移動

### 3. イベントタグ付け

1. アクションボタンをクリック（開始）
2. もう一度クリック（終了）
3. 自動的にタイムラインに追加

---

## パッケージ管理

### パッケージ作成ウィザード

| ステップ | 内容                   |
| -------- | ---------------------- |
| 基本情報 | パッケージ名、チーム名 |
| 保存先   | ディレクトリ選択       |
| 映像選択 | 寄り必須、引き任意     |
| 確認     | 設定内容の確認         |

**自動処理**:

- 映像ファイルのコピー＆リネーム
- メタデータ生成
- 音声同期分析の自動実行

### パッケージ読み込み

- メニュー → 「パッケージを開く」
- ディレクトリを選択
- 設定とタイムラインが自動復元

---

## 映像再生

### デュアル映像同期

- **自動同期**: 音声波形解析で自動同期
- **手動調整**: 設定画面で±10秒の微調整
- **同期状態表示**: プレイヤー上部に同期情報

### 再生コントロール

| 操作          | ショートカット |
| ------------- | -------------- |
| 再生/一時停止 | `Space`        |
| 5秒戻る       | `←`            |
| 5秒進む       | `→`            |
| 再生速度0.5x  | `Cmd+Shift+[`  |
| 再生速度1.0x  | `Cmd+Shift+]`  |
| 再生速度1.5x  | `Cmd+Shift+\`  |

---

## イベントタグ付け

### 基本操作

1. **開始**: アクションボタンを1回クリック
2. **終了**: 同じボタンを2回目クリック
3. **保存**: 自動保存

### コーディングパネル編集

**自由配置エディタ（FreeCanvasEditor）**:

- ドラッグ&ドロップで自由配置
- `Shift`/`Cmd`+クリックで複数選択
- グリッドスナップ（10px）
- キャンバスサイズ調整（400-2000px × 300-1500px）

**リンク作成**:

1. 右クリック+ドラッグでリンク作成
2. リンク種別選択:
   - `exclusive`（赤）: 排他的遷移
   - `activate`（緑）: アクティベート
   - `deactivate`（オレンジ）: ディアクティベート
   - `sequence`（青）: シーケンス
3. `Delete` キーで削除

**Undo/Redo**:

- `Cmd+Z`: 元に戻す
- `Cmd+Shift+Z` / `Cmd+Y`: やり直し

---

## タイムライン編集

### テーブル表示

- ソート機能（アクション名、時刻）
- インライン編集（結果、種別、修飾子）
- 映像ジャンプ（開始/終了時刻ボタン）
- 複数選択削除

### ビジュアルタイムライン

**ズーム**:

- `Cmd/Ctrl` + ホイールでズーム

**範囲選択**:

- `Shift` + ドラッグで複数選択

**操作**:

- クリック: 選択＋ジャンプ
- ダブルクリック: 編集ダイアログ
- 右クリック: コンテキストメニュー
- `Enter`: 編集
- `Delete`/`Backspace`: 削除
- エッジドラッグ: 時刻調整

### 検索・フィルタ

- テキスト検索
- チーム別フィルタ
- アクション種別フィルタ

---

## 統計分析

### 統計モーダル（`Cmd+Shift+A`）

| ビュー         | 内容                           | ショートカット |
| -------------- | ------------------------------ | -------------- |
| ポゼッション   | チーム別時間（円グラフ）       | `Cmd+Option+1` |
| アクション結果 | 結果統計（円グラフ）           | `Cmd+Option+2` |
| アクション種別 | 種別分布（円グラフ）           | `Cmd+Option+3` |
| モメンタム     | ポゼッションの流れ（棒グラフ） | `Cmd+Option+4` |
| クロス集計     | ヒートマップ                   | `Cmd+Option+5` |

### クロス集計

**カスタマイズ可能な軸**:

- 行軸/列軸: アクション名、結果、種別、修飾子
- フィルタ: チーム別、アクション別

---

## プレイリスト機能

### プレイリスト作成

#### タイムラインからの追加

1. タイムラインからイベントを選択（複数選択可）
2. 右クリック → 「プレイリストに追加」
3. メニューから操作を選択：
   - **開いている全てのプレイリストに追加**: 現在開いている全てのプレイリストウィンドウに追加
   - 既存のプレイリストから選択
   - 新しいプレイリストを作成
   - プレイリストウィンドウを開く

#### 複数ウィンドウ管理

- 同時に複数のプレイリストウィンドウを開くことができます
- 新しいウィンドウは自動的にカスケード表示されます（前のウィンドウから50pxずつオフセット）
- 同じ`.stpl`ファイルを複数回開こうとした場合は、既存のウィンドウにフォーカスします

### プレイリストファイル（.stpl）形式

プレイリストは `.stpl` 拡張子のパッケージ形式で保存されます。

**パッケージ構造**:

```
MyPlaylist.stpl/              # パッケージディレクトリ（Finderでは単一ファイルに見える）
├── playlist.json             # プレイリストメタデータ（テキストファイル）
└── videos/                   # 映像ファイル（埋め込み形式のみ）
    ├── パス_01JGXXX123ABC/   # <アクション名>_<itemId>
    │   ├── angle1.mp4        # プライマリ映像
    │   └── angle2.mp4        # セカンダリ映像（存在する場合）
    ├── シュート_01JGXXX456DEF/
    │   ├── angle1.mp4
    │   └── angle2.mp4
    └── ...
```

**形式の種類**:

- **埋め込み形式（embedded）**: 映像ファイルをFFmpegで切り出して`videos/`フォルダに含み、パッケージ単体で再生可能（大容量）
- **参照形式（reference）**: 外部映像ファイルへのパスを保存し、軽量（元の映像ファイルが必要）

**保存時の選択**:

- 初めてプレイリストを保存する際、保存ボタンを押すと形式選択ダイアログが表示されます
- 既に保存されているプレイリストは、その形式で上書き保存されます

**ファイルの閲覧**:

1. Finderでプレイリストファイルを右クリック
2. 「パッケージの内容を表示」を選択
3. `playlist.json` をテキストエディタで開いて内容確認・編集可能

**未保存変更の管理**:

- ウィンドウタイトルに未保存変更がある場合は `*` マークが表示されます
- ウィンドウを閉じる際、未保存の変更がある場合は確認ダイアログが表示されます
  - 「保存」: 変更を保存してから閉じる
  - 「保存しない」: 変更を破棄して閉じる
  - 「キャンセル」: 閉じずにウィンドウを維持

### プレイリストウィンドウ

**再生機能**:

- 連続再生
- ループ再生
- フリーズフレーム

**コントロール表示**:

- コントロールは映像エリアにマウスをホバーした時のみ表示されます
- コントロールボタンとスライダーは小型化され、より邪魔にならないデザインになっています

**描画機能**:

- 矩形、円、線、矢印、テキスト
- 色選択、線幅調整
- 消しゴム、全クリア

### クリップ書き出し

**書き出しモード**:

- 1ファイル: 全クリップを結合
- インスタンスごと: イベント単位
- アクションごと: アクション種別単位

**オーバーレイ**:

- アクション名、インデックス、ラベル、メモ

**アングル**:

- 全映像（並列）、アングル1、アングル2

---

## データのインポート・エクスポート

### エクスポート

**形式**:

- JSON形式
- CSV形式

**項目**:

- イベントID、アクション名、開始/終了時刻、ラベル、メモ

### インポート

- JSON形式のタイムライン
- 既存データとマージ
- 重複チェック

---

## 設定

### 全般設定

- テーマ（ライト/ダーク/システム）
- 自動保存間隔

### コーディングパネル設定

- レイアウト（デフォルト/カスタム）
- ボタンサイズ
- グリッドスナップ
- キャンバスサイズ

### 映像設定

- デフォルト再生速度
- 音声オフセット調整（±10秒）
- 音声同期自動実行

### ホットキー設定

- カスタムホットキー登録
- 競合チェック
- デフォルトに戻す

---

## ショートカットキー

### グローバル

| 操作             | ショートカット |
| ---------------- | -------------- |
| 新規パッケージ   | `Cmd+N`        |
| パッケージを開く | `Cmd+O`        |
| 保存             | `Cmd+S`        |
| 統計モーダル     | `Cmd+Shift+A`  |
| 設定             | `Cmd+,`        |
| ヘルプ           | `Cmd+?`        |

### 再生コントロール

| 操作          | ショートカット          |
| ------------- | ----------------------- |
| 再生/一時停止 | `Space`                 |
| 5秒戻る       | `←`                     |
| 5秒進む       | `→`                     |
| 再生速度切替  | `Cmd+Shift+[`, `]`, `\` |

### タイムライン編集

| 操作     | ショートカット        |
| -------- | --------------------- |
| 削除     | `Delete`/`Backspace`  |
| 元に戻す | `Cmd+Z`               |
| やり直し | `Cmd+Shift+Z`/`Cmd+Y` |
| 全選択   | `Cmd+A`               |
| 選択解除 | `Esc`                 |
| 編集     | `Enter`               |

### 統計ビュー切替

| ビュー         | ショートカット |
| -------------- | -------------- |
| ポゼッション   | `Cmd+Option+1` |
| アクション結果 | `Cmd+Option+2` |
| アクション種別 | `Cmd+Option+3` |
| モメンタム     | `Cmd+Option+4` |
| クロス集計     | `Cmd+Option+5` |

---

## トラブルシューティング

### 音声同期がうまくいかない

1. 両映像に音声が含まれているか確認
2. 手動オフセット調整を試す
3. `.metadata/sync.json` を削除して再計算

### 映像が再生されない

1. ファイル形式を確認（MP4/MOV推奨）
2. コーデックを確認（H.264推奨）
3. ファイルパスに日本語が含まれていないか確認

### タイムラインが保存されない

1. ディレクトリの書き込み権限を確認
2. ディスク容量を確認
3. `timeline.json` が破損している場合は削除して再作成

---

## フィードバック・サポート

GitHub Issues: https://github.com/Kou-ISK/SporTagLytics/issues

---

## 関連ドキュメント

- [開発ガイド](development.md)
- [システム概要](system-overview.md)
- [技術仕様](requirement.md)
- [プレイリスト機能実装](playlist-features.md)
- [コードウィンドウ設定実装](code-window-settings.md)
