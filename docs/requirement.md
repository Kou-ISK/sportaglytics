# SporTagLytics - 技術仕様書

---

## 1. プロジェクト概要

### 1.1 目的

スポーツ映像（特にラグビー）を分析するためのビデオタグ付けアプリケーション。映像の特定の瞬間にイベントをタグ付けし、統計分析を行うことで、戦術分析やパフォーマンス向上を支援する。

### 1.2 対象ユーザー

- スポーツアナリスト
- コーチ・監督
- 選手
- ビデオ分析担当者

### 1.3 技術スタック

| カテゴリ               | 技術          | バージョン |
| ---------------------- | ------------- | ---------- |
| フロントエンド         | React         | 18.3.1     |
| 言語                   | TypeScript    | 5.9.3      |
| デスクトップ           | Electron      | 40.0.0     |
| UI                     | Material-UI   | 5.18.0     |
| ビデオ                 | Video.js      | 8.23.4     |
| パッケージマネージャー | pnpm          | 9.1.0+     |
| ビルドツール           | react-scripts | 5.0.1      |

---

## 2. 機能要件

### 2.1 映像再生機能

#### 2.1.1 デュアル映像同期再生

- **要件**: 最大2つの映像ファイルを同時に同期再生
- **対応フォーマット**: MP4、MOV
- **推奨コーデック**: H.264/AVC、AAC音声
- **表示レイアウト**: サイドバイサイド（左右並列）

#### 2.1.2 音声同期機能

**自動同期**:

- 音声波形の相互相関分析による自動オフセット検出
- FFT（高速フーリエ変換）を用いた特徴量計算
- ファイル名ベースのカメラ種別ヒント検出（寄り/引き、tight/wide）
- 同期信頼度スコア（0-100%）の算出と色分け表示
- 分析プログレスバーの表示

**手動調整**:

- 手動オフセット調整ダイアログ（`Cmd+Shift+O`）
- 同期リセット機能（`Cmd+Shift+R`）
- 同期再実行（`Cmd+Shift+S`）

**データ保存**:

- パッケージ内の `.metadata/sync.json` に保存
- オフセット値、信頼度、分析日時を記録

#### 2.1.3 共通シークバー

- 1つのスライダーで複数映像を同時制御
- 同期オフセットを考慮した時刻調整
- 同期状態の視覚的表示（オフセット値・信頼度）
- NaN防止の多層防護（型チェック、範囲検証）

#### 2.1.4 映像制御

**再生/停止**:

- UIボタン、`↑`キー

**再生速度**:

- 0.5倍速: `→`キー
- 1.0倍速: デフォルト
- 2.0倍速: `Shift + →`
- 4.0倍速: `Cmd + →`
- 6.0倍速: `Option + →`

**シーク**:

- 5秒戻し: `←`キー
- 10秒戻し: `Shift + ←`
- スライダーによる任意位置ジャンプ

**編集操作**:

- 削除: `Delete`/`Backspace`（選択したタイムラインまたはコーディングパネル要素）
- 元に戻す: `Cmd + Z`
- やり直し: `Cmd + Shift + Z` または `Cmd + Y`

### 2.2 イベントタグ付け機能

#### 2.2.1 リアルタイムタグ付け

- **1回目ボタン押下**: イベント開始時刻を記録（ボタンがアクティブ状態に変化）
- **2回目ボタン押下**: イベント終了時刻を記録（タイムラインデータ生成）
- **自動保存**: 明示的な保存ボタン操作による

#### 2.2.2 対応アクション（ラグビー）

| アクション   | 主な結果                            | 主な種別                                  |
| ------------ | ----------------------------------- | ----------------------------------------- |
| ポゼッション | Try, Drop Goal, Pen Won, Turnover   | Kick Return, Turnover Won, Lineout, Scrum |
| スクラム     | Won Outright, Won PK, Lost Outright | Positive, Neutral, Negative               |
| ラインアウト | Won, Won & Maul, Lost               | Front, Middle, Back                       |
| キック       | Touch(Bounce), Touch(Full), Error   | Bomb, Chip, Territorial, Box              |
| PK           | Not Releasing, Offside, Foul Play   | Offence, Defence                          |
| トライ       | Conversion Success/Missed           | BK, FW                                    |
| ショット     | Success, Missed                     | -                                         |
| チェック     | Good, Bad                           | Offence, Defence                          |

詳細は `src/ActionList.ts` 参照。

#### 2.2.3 チーム別タグ付け

- 2チーム設定可能
- チーム別ボタン色分け（チーム1: 赤系統、チーム2: 青系統）
- アクション名に自動的にチーム名を付加

#### 2.2.4 コーディングパネル編集機能

**自由配置エディタ（FreeCanvasEditor）**:

- **ボタンの自由配置**: ドラッグ&ドロップでボタンを任意の位置に配置
- **リンク作成**: 右クリック+ドラッグでボタン間のリンクを作成
- **リンク種別**:
  - `exclusive`（赤矢印）: 排他的遷移
  - `activate`（緑矢印）: アクティベート
  - `deactivate`（オレンジ矢印）: ディアクティベート
  - `sequence`（青矢印）: シーケンス
- **リンク選択**: クリックでリンクを選択（青い円でハイライト表示）
- **削除操作**: `Delete`/`Backspace` キーで選択中のリンクまたはボタンを削除
- **Undo/Redo**: `Cmd+Z` で元に戻す、`Cmd+Shift+Z`/`Cmd+Y` でやり直し（最大50件の履歴）

### 2.3 タイムライン管理機能

#### 2.3.1 データ構造

```typescript
TimelineData = {
  id: string;           // ユニークID（ULID）
  actionName: string;   // アクション名（チーム名 + アクション種別）
  startTime: number;    // 開始時刻（秒）
  endTime: number;      // 終了時刻（秒）
  actionResult: string; // アクション結果
  actionType: string;   // アクション種別
  qualifier: string;    // 追加情報・修飾子
  labels?: Array<{ name: string; group?: string }>; // ラベルグループ構造
  color?: string;       // タイムライン上での表示色
}
```

#### 2.3.2 テーブル表示・編集機能

- **テーブル表示**: 時系列での一覧表示
- **ソート**: アクション名、開始時刻、終了時刻でソート可能
- **インライン編集**:
  - アクション結果: ドロップダウン選択
  - アクション種別: ドロップダウン選択
  - 修飾子: テキスト入力
- **映像ジャンプ**: 開始/終了時刻ボタンで該当位置に移動
- **複数選択削除**: チェックボックス + 削除ボタン、または `Delete`/`Backspace` キー
- **Undo/Redo**: `Cmd+Z` で元に戻す、`Cmd+Shift+Z`/`Cmd+Y` でやり直し（最大50件の履歴）

#### 2.3.3 ビジュアルタイムライン（VisualTimeline）

**概要**:

横型波形表示で直感的にイベントを確認・編集できるタイムラインUI。

**主要コンポーネント**:

| コンポーネント      | 機能                                                |
| ------------------- | --------------------------------------------------- |
| VisualTimeline      | メインコンテナ、タブ切り替え（テーブル/ビジュアル） |
| TimelineLane        | レーン描画、エッジドラッグでの時間調整              |
| TimelineAxis        | 時間軸の目盛り表示                                  |
| ZoomIndicator       | ズーム倍率のインジケーター                          |
| TimelineContextMenu | 右クリックメニュー                                  |
| TimelineEditDialog  | インライン編集ダイアログ                            |
| BulkMoveDialog      | 複数選択時の一括移動ダイアログ                      |
| TimelineHeader      | ヘッダー（ツールバー、フィルタ）                    |

**ズーム機能**:

- `Cmd/Ctrl + ホイール`でズームイン/アウト
- ZoomIndicatorで現在のズーム倍率を表示
- ビューポート管理（useTimelineViewport）で効率的な描画

**範囲選択機能**:

- Shiftキー + ドラッグで複数イベントを範囲選択
- 選択範囲のハイライト表示
- useTimelineRangeSelectionフックで状態管理

**インタラクション**:

- クリック: イベントを選択、該当映像位置にジャンプ
- ダブルクリック: 編集ダイアログを開く
- 右クリック: コンテキストメニュー（編集/削除/ジャンプ/ラベル編集）
- Enterキー: 選択中のイベントを編集
- Delete/Backspaceキー: 選択中のイベントを削除
- エッジドラッグ: 開始/終了時刻の調整

**ラベル付与機能**:

- ラベル選択ダイアログ（labelDialogOpen）
- 複数ラベルグループに対応
- ラベルのチップ表示

**クリップ書き出し機能**:

- 選択したイベントを映像クリップとして書き出し
- テキストオーバーレイオプション（clipDialogOpen）
- アクション名、インデックス、ラベル、修飾子の表示設定

**関連カスタムフック**:

| フック                    | 責務                                     |
| ------------------------- | ---------------------------------------- |
| useTimelineViewport       | ズーム・ビューポート管理                 |
| useTimelineInteractions   | 選択、コンテキストメニュー、編集ハンドラ |
| useTimelineEditDraft      | 編集ダイアログの入力状態管理             |
| useTimelineValidation     | 入力値のバリデーション                   |
| useTimelineRangeSelection | 範囲選択の状態管理                       |

#### 2.3.4 検索・フィルタリング

- **テキスト検索**: アクション名、修飾子、結果、種別の横断検索
- **チーム別フィルタ**: ドロップダウンで特定チームのみ表示
- **アクション種別フィルタ**: 種別による絞り込み
- **リアルタイム件数表示**: フィルタ適用後の件数表示

#### 2.3.5 データ永続化

- **ファイル形式**: JSON
- **保存場所**: `<パッケージディレクトリ>/timeline.json`
- **保存タイミング**: 自動保存（数百msデバウンス）

### 2.4 パッケージ管理機能

#### 2.4.1 パッケージ構造

```
PackageName/
├── .metadata/
│   ├── config.json          # チーム名、アクションリスト設定
│   └── sync.json            # 音声同期データ（自動生成）
├── timeline.json            # タイムラインデータ
└── videos/
    ├── PackageName 寄り.mp4 # タイトビュー映像
    └── PackageName 引き.mp4 # ワイドビュー映像（オプション）
```

#### 2.4.2 パッケージ作成

**4ステップウィザード**:

1. **基本情報入力**: パッケージ名、チーム1名、チーム2名
2. **保存先選択**: ディレクトリ選択
3. **映像ファイル選択**: 寄り必須、引き任意
4. **確認**: 設定内容の確認

**自動処理**:

- 映像ファイルのコピー＆リネーム
- `.metadata/config.json` の生成
- 音声同期分析の自動実行

#### 2.4.3 パッケージ読み込み

- ディレクトリ選択による一括読み込み
- ドラッグ&ドロップ対応
- チーム名、アクションリスト、タイムラインデータの自動復元

### 2.5 統計分析・可視化機能

#### 2.5.1 統計モーダル（`Cmd+Shift+A`）

**5つの分析ビュー**:

| ビュー         | 内容                                            | ショートカット |
| -------------- | ----------------------------------------------- | -------------- |
| ポゼッション   | チーム別ポゼッション時間の円グラフ（MM:SS形式） | `Cmd+Option+1` |
| アクション結果 | チーム別・アクション別の結果統計（円グラフ）    | `Cmd+Option+2` |
| アクション種別 | アクション種別の分布統計（円グラフ）            | `Cmd+Option+3` |
| モメンタム     | ポゼッションの流れを棒グラフで可視化            | `Cmd+Option+4` |
| クロス集計     | 任意の軸でヒートマップ表示                      | `Cmd+Option+5` |

**モメンタムチャート**:

- ポゼッション時間の棒グラフ
- チーム別色分け（赤/青）
- 結果による色分け（Try: オレンジ、Positive: 緑、Negative: 紫、Neutral: グレー）
- バークリックで該当映像位置にジャンプ

**クロス集計（MatrixTab）**:

- 任意の行軸・列軸を選択可能（チーム、アクション、ラベルグループ、all_labels）
- ヒートマップ形式でセル値を色の濃さで表示
- チーム/アクション/ラベルによるフィルタリング
- セルクリックで該当イベントへジャンプ
- ドリルダウンダイアログで詳細一覧表示

#### 2.5.2 チャートインタラクション

- チャート要素クリックで該当映像位置にジャンプ
- スクロール対応の統計情報表示
- タブ切り替えで各ビューを表示

### 2.6 設定機能（SettingsPage）

設定画面は `Cmd + ,` で開く。4つのタブで構成。

#### 2.6.1 一般設定（GeneralSettings）

- **テーマ**: ライト/ダーク/システム連動の切替
- 設定はアプリ全体に即時反映

#### 2.6.2 アクションプリセット設定（ActionPresetSettings）

**プリセット管理**:

- 複数プリセットの作成・編集・削除
- アクティブプリセットの切替
- プリセットのインポート/エクスポート（JSON形式）

**アクション定義**:

- アクション名、ラベルグループ、ホットキーの設定
- ラベルグループ構造（name + group）でのカテゴリ化
- アクションごとの色設定

**ホットキー設定**:

- アクションごとにホットキーを割り当て
- Shift+キーで2チーム目のアクションを起動

#### 2.6.3 ホットキー設定（HotkeySettings）

再生制御、同期操作、分析機能のホットキーをカスタマイズ。

| ID                   | デフォルト     | 説明             |
| -------------------- | -------------- | ---------------- |
| resync-audio         | `Cmd+Shift+S`  | 音声同期を再実行 |
| reset-sync           | `Cmd+Shift+R`  | 同期をリセット   |
| manual-sync          | `Cmd+Shift+M`  | 今の位置で同期   |
| toggle-manual-mode   | `Cmd+Shift+T`  | 手動モード切替   |
| analyze              | `Cmd+Shift+A`  | 分析開始         |
| undo                 | `Cmd+Z`        | 元に戻す         |
| redo                 | `Cmd+Shift+Z`  | やり直す         |
| skip-forward-small   | `Right`        | 0.5倍速再生      |
| skip-forward-medium  | `Shift+Right`  | 2倍速再生        |
| skip-forward-large   | `Cmd+Right`    | 4倍速再生        |
| skip-forward-xlarge  | `Option+Right` | 6倍速再生        |
| skip-backward-medium | `Left`         | 5秒戻し          |
| skip-backward-large  | `Shift+Left`   | 10秒戻し         |
| play-pause           | `Space`        | 再生/停止        |

#### 2.6.4 コードウィンドウ設定（CodeWindowSettings）

**自由配置エディタ（FreeCanvasEditor）**:

- キャンバス上にボタンを自由配置
- ドラッグ&ドロップでボタン移動
- ボタンのリサイズ
- キャンバスサイズの調整（幅400-2000px、高さ30 0-1500px）
- グリッドスナップ（10px）
- 複数ボタンの同時選択（Shift/Cmd+クリック）
- 選択ボタンのまとめ移動・サイズ変更

**ボタン設定（ButtonPropertiesEditorNew）**:

- ボタン名（プレースホルダー対応: `${Team1}`, `${Team2}`）
- ボタン色の設定
- テキスト色の設定
- フォントサイズ調整
- 角丸設定
- ホットキー設定（例: "a", "1", "Shift+B"）
- プレースホルダー挿入ボタン（ワンクリックで挿入）

**リンク設定**:

- ボタン間のリンク作成（右クリック+ドラッグ）
- リンク種別:
  - `exclusive`（赤）: 排他的遷移（矢印なし、双方向）
  - `activate`（緑矢印）: アクティベート
  - `deactivate`（オレンジ矢印）: ディアクティベート
  - `sequence`（青矢印）: シーケンス
- リンクの選択・削除（クリックで選択、Delete/Backspaceで削除）
- リンク端点の最適化（getButtonEdge関数）

**Undo/Redo機能**:

- 配置・リンク編集の履歴管理（最大50件）
- `Cmd+Z`: 元に戻す
- `Cmd+Shift+Z`/`Cmd+Y`: やり直し
- isUndoRedoRef でループ防止

**レイアウト管理**:

- 複数レイアウトの保存・切替
- アクティブレイアウトの設定
- レイアウトの新規作成/複製/削除
- レイアウトのエクスポート/インポート（.codewindow形式）

### 2.7 ユーザーサポート機能

#### 2.7.1 オンボーディングチュートリアル

- 初回起動時に自動表示
- 4ステップのウィザード形式
- LocalStorageで完了フラグを管理
- スキップ機能

#### 2.7.2 ショートカットガイド

- コントローラー右上の「?」アイコンから表示
- カテゴリ別一覧（再生制御、音声同期、統計・分析）
- モーダル形式での表示

#### 2.7.3 エラーハンドリング

- 統一エラーステート（useVideoPlayerApp）
- エラータイプ分類: file, network, sync, playback, general
- Snackbar通知（6秒自動非表示）
- エラー種別による色分け

### 2.8 タイムラインエクスポート/インポート

#### 2.8.1 対応フォーマット

| フォーマット | 用途                                                          |
| ------------ | ------------------------------------------------------------- |
| JSON         | アプリ内部形式（完全な情報保持）                              |
| CSV          | YouTube用（時刻, 終了時刻, アクション名, タイプ, 結果, 備考） |
| SCTimeline   | Sportscode互換JSON（行/インスタンス形式）                     |

#### 2.8.2 操作方法

- メニュー「タイムライン」→エクスポート/インポート
- インポート時はJSON優先、失敗時にSCTimeline自動判定

### 2.9 プレイリスト機能

#### 2.9.1 プレイリスト管理

**アイテム追加**:

- タイムラインから複数選択でプレイリストに追加（右クリックメニューまたはツールバーボタン）
- 新規プレイリスト作成または既存プレイリストへ追加を選択可能

**複数プレイリスト管理**:

- 複数0個のプレイリストを作成・切替
- PlaylistContext で状態管理
- JSON形式でファイルに保存/読み込み

**順序管理**:

- ドラッグ&ドロップで順序変更（@dnd-kit使用）
- アイテムの削除・編集

#### 2.9.2 プレイリスト専用ウィンドウ

**基本再生機能**:

- 連続再生: 自動的に次のアイテムへ移動（autoAdvance）
- ループ再生: プレイリスト全体を繰り返し再生（loopPlaylist）
- 前/次アイテムジャンプ、再生/一時停止、音量調整

**フリーズフレーム機能**:

- 任意の位置でビデオを一時停止、静止画として表示
- フリーズ中は再生コントロールを無効化
- 描画モードとの連携

**簡易描画機能**:

- 描画モード切替（Brush アイコン）
- 図形描画: 矩形、円、線、矢印
- テキスト描画: フォントサイズ、色調整可能
- 描画履歴: 描画オブジェクトの選択・移動・削除
- アイテムごとに描画データを保持（ItemAnnotation）
- PNG画像としてエクスポート可能

**デュアルビュー機能**:

- 1映像/2映像並列表示の切替
- 各映像への個別描画対応
- プライマリ/セカンダリ映像の切替

**メモ編集**:

- 各アイテムに個別のメモを追加/編集
- タイムラインのメモとは独立に管理

**クリップ書き出し**:

- 書き出しモード: 1ファイル/インスタンスごと/アクションごと
- アングル選択: 全映像/アングル1のみ/アングル2のみ
- オーバーレイ設定: アクション名、インデックス、ラベル、メモの表示切替
- FFmpeg統合（ffmpeg-static使用）

#### 2.9.3 メインウィンドウとの連携

**双方向通信**:

- メイン → プレイリスト: PlaylistSyncDataで状態同期
- プレイリスト → メイン: PlaylistCommandでシーク/再生要求

**ウィンドウ管理**:

- Electron IPC経由でウィンドウ開閉管理
- playlistWindow.ts でウィンドウライフサイクル管理
- Hash routingで #/playlist ルートを表示

---

## 3. 非機能要件

### 3.1 パフォーマンス

- 映像再生のスムーズさ（60fps目標）
- タグ付け操作の即座の反応（100ms以内）
- 長時間映像ファイルの安定処理

### 3.2 ユーザビリティ

- 直感的操作（専門知識を持つユーザーが迷わず操作可能）
- キーボードショートカットによる効率的な操作
- 映像とコントロールパネルの適切な配置
- レスポンシブ対応（xs: 40vh, sm: 50vh, md: 55vh, lg: 60vh）

### 3.3 信頼性

- タイムラインデータの確実な保存
- ファイル読み込みエラー・映像再生エラーの適切な処理
- プレイヤー健全性チェック（`player.el()`, `player.error()`, ビデオ要素存在確認）
- プレイヤーエラーからの自動回復機能

### 3.4 拡張性

- 新しいスポーツ・分析項目への対応（ActionList.tsの拡張）
- 新しい映像フォーマットのサポート
- エクスポート機能（CSV、Excel）への拡張可能性

---

## 4. 技術的制約

### 4.1 プラットフォーム

- **優先対応**: macOS（dmgファイルでの配布）
- **将来対応**: Windows、Linux

### 4.2 映像フォーマット

- **対応**: MP4、MOV
- **推奨コーデック**: H.264/AVC（映像）、AAC（音声）
- **同時映像数**: 最大2つ

### 4.3 開発環境

- **Node.js**: 18.0.0以上
- **pnpm**: 9.0.0以上
- **TypeScript**: strict mode有効
- **React**: 関数コンポーネントのみ

---

## 5. アーキテクチャ設計

### 5.1 ディレクトリ構成

```
src/
├── features/                      # 機能単位のモジュール
│   └── videoPlayer/
│       ├── analysis/              # 統計分析ロジック
│       │   ├── hooks/             # 分析用カスタムフック
│       │   └── utils/             # 分析ユーティリティ
│       └── components/
│           ├── Analytics/         # 統計分析UI
│           │   └── StatsModal/    # 統計モーダル
│           │       └── view/      # 各ビュー（Possession/Results/Types/Momentum/Matrix）
│           ├── Controls/          # コントロールパネル
│           │   └── VideoController/
│           ├── Player/            # ビデオプレイヤー
│           │   ├── SingleVideo/   # 単体プレイヤー
│           │   └── SyncedVideo/   # 同期プレイヤー
│           ├── Setup/             # 初期設定
│           │   └── VideoPathSelector/  # パッケージ選択
│           │       ├── components/     # UIコンポーネント
│           │       ├── hooks/          # カスタムフック
│           │       └── steps/          # ウィザードステップ
│           └── Timeline/          # タイムライン
│               └── VisualTimeline/    # ビジュアルタイムライン
│                   └── hooks/         # タイムライン用フック
├── pages/                         # ページコンポーネント
│   ├── settings/                  # 設定画面
│   │   └── components/            # 設定タブコンポーネント
│   │       └── CodeWindowSettings/  # コードウィンドウ設定
│   └── videoPlayer/               # ビデオプレイヤーページ
│       ├── components/            # ページ固有コンポーネント
│       └── hooks/                 # ページ固有フック
├── hooks/                         # 共通カスタムフック
│   └── videoPlayer/               # ビデオプレイヤー用共通フック
├── types/                         # 型定義
├── utils/                         # ユーティリティ
├── contexts/                      # Context API
└── components/                    # 共通コンポーネント

electron/
└── src/
    ├── main.ts                    # メインプロセス
    ├── preload.ts                 # プリロードスクリプト
    ├── menuBar.ts                 # メニューバー定義
    ├── settingsManager.ts         # 設定管理
    ├── shortCutKey.ts             # グローバルショートカット
    └── utils.ts                   # ユーティリティ
```

### 5.2 主要コンポーネント一覧

| コンポーネント      | パス                                           | 責務                     |
| ------------------- | ---------------------------------------------- | ------------------------ |
| VideoPlayerApp      | pages/VideoPlayerApp.tsx                       | メインページ             |
| SettingsPage        | pages/SettingsPage.tsx                         | 設定画面（4タブ）        |
| VisualTimeline      | features/.../Timeline/VisualTimeline/          | ビジュアルタイムライン   |
| StatsModal          | features/.../Analytics/StatsModal/             | 統計モーダル             |
| EnhancedCodePanel   | features/.../Controls/                         | コーディングパネル       |
| SyncedVideoPlayer   | features/.../Player/SyncedVideo/               | 同期ビデオプレイヤー     |
| VideoPathSelector   | features/.../Setup/VideoPathSelector/          | パッケージ選択・作成     |
| CreatePackageWizard | features/.../Setup/.../CreatePackageWizard.tsx | パッケージ作成ウィザード |
| FreeCanvasEditor    | pages/settings/.../CodeWindowSettings/         | コードウィンドウ編集     |

### 5.3 主要カスタムフック一覧

| フック                    | パス                                        | 責務                 |
| ------------------------- | ------------------------------------------- | -------------------- |
| useVideoPlayerApp         | hooks/useVideoPlayerApp.ts                  | アプリ全体の状態管理 |
| useSettings               | hooks/useSettings.ts                        | 設定の読み書き       |
| useGlobalHotkeys          | hooks/useGlobalHotkeys.ts                   | グローバルホットキー |
| useSyncActions            | hooks/videoPlayer/useSyncActions.ts         | 同期操作             |
| useTimelineEditing        | hooks/videoPlayer/useTimelineEditing.ts     | タイムライン編集     |
| useTimelineHistory        | hooks/videoPlayer/useTimelineHistory.ts     | Undo/Redo履歴        |
| useTimelinePersistence    | hooks/videoPlayer/useTimelinePersistence.ts | 永続化               |
| useTimelineSelection      | hooks/videoPlayer/useTimelineSelection.ts   | 選択状態             |
| useTimelineViewport       | features/.../VisualTimeline/hooks/          | ズーム・ビューポート |
| useTimelineInteractions   | features/.../VisualTimeline/hooks/          | インタラクション     |
| useTimelineEditDraft      | features/.../VisualTimeline/hooks/          | 編集ドラフト         |
| useTimelineValidation     | features/.../VisualTimeline/hooks/          | バリデーション       |
| useTimelineRangeSelection | features/.../VisualTimeline/hooks/          | 範囲選択             |
| useMatrixAxes             | features/.../StatsModal/view/hooks/         | クロス集計軸         |
| useMatrixFilters          | features/.../StatsModal/view/hooks/         | クロス集計フィルタ   |

### 5.4 設計原則

1. **関数コンポーネントのみ**: React 18の関数コンポーネント + Hooks
2. **責務分離**: View（JSX）とロジック（Hooks）を明確に分離
3. **型安全性**: TypeScript strict mode、`any`の最小化
4. **Feature-based構造**: 機能単位でコード整理、依存関係の明確化
5. **Material UI標準**: `sx`プロパティでスタイリング統一

### 5.5 命名規則

- **Reactコンポーネント**: PascalCase（ファイル・ディレクトリ含む）
- **ロジックモジュール**: camelCase
- **カスタムHook**: `useXxx.ts`形式
- **型定義**: PascalCase

### 5.6 状態管理

- **ローカル状態**: useState
- **副作用**: useEffect（完全な依存配列 + クリーンアップ必須）
- **メモ化**: useMemo、useCallback
- **Context**: NotificationContext（通知管理）、ActionPresetContext（プリセット管理）、ThemeModeContext（テーマ管理）

---

## 6. 実装済み改善履歴

### 6.1 パッケージ作成UX改善（2025年10月）

- 4ステップウィザード形式
- リアルタイム入力バリデーション
- 視覚的フィードバック（進捗インジケーター）

### 6.2 デザインシステム（NEON, Dark-first, 2025年12月）

最新のデザインシステム仕様は `docs/design-system.md` を参照してください。テーマ実装は `src/theme.ts` をソースオブトゥルースとし、画面は MUI テーマ経由で色/タイポ/余白を取得する方針です。

### 6.3 キーボードショートカット可視化（2025年10月）

- ショートカットガイドコンポーネント
- カテゴリ別一覧表示

### 6.4 エラーハンドリング強化（2025年10月）

- 統一エラーステート
- エラータイプ分類
- Snackbar通知

### 6.5 タイムライン検索・フィルタリング強化（2025年10月）

- 複合検索機能
- リアルタイム件数表示

### 6.6 プレイヤー安定性改善（2025年10月）

- 共通シークバーNaN表示問題の修正
- 2つ目の映像消失問題の修正
- プレイヤー健全性チェック強化

### 6.7 タイムライン操作UX改善（2025年）

- **Undo/Redo機能**: タイムライン編集履歴の管理（最大50件）
  - `Cmd+Z`: 元に戻す
  - `Cmd+Shift+Z`/`Cmd+Y`: やり直し
- **削除ホットキー**: `Delete`/`Backspace` キーで選択したタイムラインを削除
- **設定ファイル後方互換性**: 新しいホットキー設定が自動的にマージされる

### 6.8 コーディングパネル編集改善（2025年）

- **リンク矢印表示改善**: リンク種別ごとの色付きマーカー
  - `exclusive`: 赤（矢印なし、双方向の排他関係を表現）
  - `activate`: 緑矢印
  - `deactivate`: オレンジ矢印
  - `sequence`: 青矢印
- **リンク端点改善**: 矢印がボタン端で終わるように調整（getButtonEdge関数）
- **リンク選択機能**: クリックでリンクを選択、青い円でハイライト表示
- **削除操作**: `Delete`/`Backspace` キーで選択中のリンクまたはボタンを削除
- **Undo/Redo機能**: 配置・リンク編集の履歴管理（最大50件）
  - `Cmd+Z`: 元に戻す
  - `Cmd+Shift+Z`/`Cmd+Y`: やり直し
- **プレースホルダー挿入UI**: `${Team1}`, `${Team2}`, スペースをワンクリックで挿入

### 6.9 ビジュアルタイムライン機能（2025年）

- **横型波形タイムライン**: TimelineLaneコンポーネントでイベントを視覚的に表示
- **ズーム機能**: `Cmd+ホイール`でズームイン/アウト、ZoomIndicatorで倍率表示
- **範囲選択**: Shift+ドラッグで複数イベントを選択
- **エッジドラッグ**: イベントの開始/終了時刻をドラッグで調整
- **コンテキストメニュー**: 右クリックで編集/削除/ジャンプ/ラベル編集
- **編集ダイアログ**: Enter キーで時刻・メモ・ラベルをまとめて編集
- **ラベル付与**: 複数ラベルグループに対応したラベル選択ダイアログ
- **クリップ書き出し**: 選択イベントを映像クリップとして書き出し

### 6.10 クロス集計機能（2025年）

- **MatrixTab**: 統計モーダルに追加された5番目のビュー
- **カスタム軸設定**: 行軸・列軸を任意に選択（チーム、アクション、ラベルグループ）
- **フィルタリング**: チーム/アクション/ラベルでフィルタ
- **ヒートマップ表示**: セル値を色の濃さで視覚化
- **ドリルダウン**: セルクリックで詳細一覧を表示

### 6.11 タイムラインエクスポート/インポート（2025年）

- **JSON形式**: アプリ内部形式（完全な情報保持）
- **CSV形式**: YouTube用に時刻・アクション情報を出力
- **SCTimeline形式**: Sportscode互換JSON（行/インスタンス形式）

---

## 7. 今後の拡張予定

### 7.1 機能拡張

- **複数試合比較**: 複数パッケージ間の比較分析
- **クリップ書き出し改善**: バッチ書き出し、透かし設定

### 7.2 分析機能拡張

- **時系列分析**: 試合の流れの詳細分析
- **ヒートマップ**: アクション発生位置の可視化（フィールド上）
- **高度な統計**: 勝率予測、パフォーマンス指標

### 7.3 UI/UX改善

- **多言語対応**: 英語UI対応
- **クラウド同期**: パッケージデータのクラウドバックアップ

---

## 8. セキュリティ・プライバシー

### 8.1 データ保存

- **ローカルストレージのみ**: すべてのデータはユーザーのローカルディスクに保存
- **外部送信なし**: 映像・タイムラインデータは外部に送信されない

### 8.2 権限

- **ファイルシステム**: ユーザーが選択したディレクトリのみアクセス
- **macOS権限**: ファイルアクセス権限の適切な要求

---

## 9. テスト戦略

### 9.1 型チェック

```bash
pnpm exec tsc --noEmit          # React側
pnpm exec tsc -p electron --noEmit  # Electron側
```

### 9.2 ユニットテスト

- `pnpm test` でReact Testing Libraryによるテスト実行
- 重要なユーティリティ関数のテスト

### 9.3 手動テスト

- タイムライン永続化機能の動作確認
- 音声同期機能の精度確認
- 長時間映像での安定性確認

---

## 10. ビルド・デプロイ

### 10.1 開発環境

```bash
pnpm run electron:dev  # React + Electron同時起動
```

### 10.2 本番ビルド

```bash
pnpm run electron:start  # 最適化ビルド + 起動
```

### 10.3 配布用ビルド

```bash
pnpm run electron:build  # dmgファイル生成（dist/配下）
```

---

## 11. 依存関係管理

### 11.1 主要ライブラリ

- **React**: UI構築
- **TypeScript**: 型安全性
- **Electron**: デスクトップアプリケーション化
- **Material-UI**: UIコンポーネント
- **Video.js**: ビデオプレイヤー
- **Recharts**: グラフ可視化
- **ulid**: ユニークID生成

### 11.2 アップデート方針

- **メジャーバージョン**: 慎重に検証後アップデート
- **マイナー/パッチ**: 定期的にアップデート
- **セキュリティパッチ**: 即座にアップデート

---

## 12. ライセンス

MIT

---

## 13. 参考資料

- [プロジェクトリポジトリ](https://github.com/Kou-ISK/sportaglytics)
- [Copilot基本指示](.github/copilot-instructions.md)
- [TypeScript指示](.github/instructions/typescript.instructions.md)
- [TSX指示](.github/instructions/tsx.instructions.md)
